<!DOCTYPE html>
<html>
  <head>
    <title>Testing WebAssembly</title>
    <script src="wasm_exec.js"></script>
    <script type="text/javascript">
      function fetchAndInstantiate(url, importObject) {
        return fetch(url)
          .then(response => response.arrayBuffer())
          .then(bytes => WebAssembly.instantiate(bytes, importObject))
          .then(results => results.instance);
      }
      const go = new Go();
      window.onload = async () => {
        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        const image = ctx.createImageData(160, 144);

        const ins = await fetchAndInstantiate("/main.wasm", go.importObject);
        go.run(ins);
        const rom = await fetch("./hello.gb");
        const buf = await rom.arrayBuffer();
        const gb = new GB(new Uint8Array(buf));

        const frame = () => {
          const img = gb.next();
          image.data.set(img);
          ctx.putImageData(image, 0, 0);
          window.requestAnimationFrame(frame);
        };
        frame();

        window.addEventListener("keydown", e => {
          switch (e.key) {
            case "z":
              return gb.keyDown(0x01);
            case "x":
              return gb.keyDown(0x02);
            case "Backspace":
              return gb.keyDown(0x04);
            case "Enter":
              return gb.keyDown(0x08);
            case "ArrowLeft":
              return gb.keyDown(0x20);
            case "ArrowUp":
              return gb.keyDown(0x40);
            case "ArrowRight":
              return gb.keyDown(0x10);
            case "ArrowDown":
              return gb.keyDown(0x80);
          }
        });

        window.addEventListener("keyup", e => {
          switch (e.key) {
            case "z":
              return gb.keyUp(0x01);
            case "x":
              return gb.keyUp(0x02);
            case "Backspace":
              return gb.keyUp(0x04);
            case "Enter":
              return gb.keyUp(0x08);
            case "ArrowLeft":
              return gb.keyUp(0x20);
            case "ArrowUp":
              return gb.keyUp(0x40);
            case "ArrowRight":
              return gb.keyUp(0x10);
            case "ArrowDown":
              return gb.keyUp(0x80);
          }
        });

        const addHandler = (classname, bit) => {
          const el = document.querySelector(`.${classname}`);
          el.addEventListener("mousedown", e => {
            return gb.keyDown(bit);
          });
          el.addEventListener("touchstart", e => {
            return gb.keyDown(bit);
          });
          el.addEventListener("mouseup", e => {
            return gb.keyUp(bit);
          });
          el.addEventListener("touchend", e => {
            return gb.keyUp(bit);
          });
        };

        addHandler("buttonA", 0x01);
        addHandler("buttonB", 0x02);
        addHandler("buttonSelect", 0x04);
        addHandler("buttonStart", 0x08);

        addHandler("right", 0x10);
        addHandler("left", 0x20);
        addHandler("up", 0x40);
        addHandler("down", 0x80);
      };
    </script>
    <style>
      html {
        padding: 0;
        margin: 0;
      }
      body {
        background: #1abc9c;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 0;
        margin: 0;
      }
      .gameboy {
        height: 480px;
        width: 300px;
        position: relative;
        background: #eee;
        border-radius: 10px 10px 50px 10px;
        overflow: hidden;
        box-shadow: 5px 5px rgba(0, 0, 0, 0.1);
        transform: scale(1.5);
        /*cursor: pointer*/
      }
      .gameboy:before {
        position: absolute;
        width: 500px;
        height: 20px;
        border-bottom: 3px solid #e0e0e0;
        content: "";
      }
      .gameboy:after {
        position: absolute;
        width: 240px;
        height: 20px;
        left: 24px;
        border-left: 3px solid #e0e0e0;
        border-right: 3px solid #e0e0e0;
        content: "";
      }
      .screen {
        position: absolute;
        width: 252px;
        height: 188px;
        left: 24px;
        top: 40px;
        background: #777;
        border-radius: 5px 5px 40px 5px;
      }
      canvas {
        background: #aec5a0;
        position: absolute;
        top: 22px;
        left: 48px;
      }
      .led {
        position: absolute;
        height: 8px;
        width: 8px;
        top: 107px;
        left: 42px;
        border-radius: 100%;
        box-shadow: 1px 1px 0 #400 inset;
        background: #600;
        content: "";
      }

      .pad {
        position: absolute;
        width: 26px;
        height: 80px;
        top: 296px;
        left: 50px;
        background: #444;
        border-radius: 3px;
        z-index: 998;
      }
      .pad:after {
        position: absolute;
        width: 80px;
        height: 26px;
        top: 26px;
        left: -26px;
        background: #444;
        border-radius: 3px;
        content: "";
        z-index: 999;
      }
      .pad:before {
        position: absolute;
        height: 26px;
        width: 26px;
        top: 26px;
        border-radius: 100%;
        background: #333;
        content: "";
        z-index: 1000;
      }

      .up {
        position: absolute;
        width: 26px;
        height: 30px;
        top: 296px;
        left: 50px;
        border-radius: 3px;
        z-index: 998;
        cursor: pointer;
      }

      .down {
        position: absolute;
        width: 26px;
        height: 30px;
        top: 346px;
        left: 50px;
        border-radius: 3px;
        z-index: 998;
        cursor: pointer;
      }

      .right {
        position: absolute;
        width: 26px;
        height: 28px;
        top: 322px;
        left: 78px;
        border-radius: 3px;
        z-index: 998;
        cursor: pointer;
      }

      .left {
        position: absolute;
        width: 26px;
        height: 28px;
        top: 322px;
        left: 24px;
        border-radius: 3px;
        z-index: 998;
        cursor: pointer;
      }

      .hole {
        position: absolute;
        height: 46px;
        width: 6px;
        top: 436px;
        left: 190px;
        border-radius: 2px;
        background: #ddd;
        -webkit-transform: rotate(-30deg);
        box-shadow: 0px 0px #ddd, 17px 0px #ddd, 34px 0px #ddd, 51px 0px #ddd,
          68px 0px #ddd, 85px 0px #ddd;
        content: "";
      }
      .buttonB {
        position: absolute;
        width: 36px;
        height: 36px;
        top: 322px;
        right: 69px;
        border-radius: 100%;
        background: #a93671;
        cursor: pointer;
      }

      .buttonA {
        position: absolute;
        width: 36px;
        height: 36px;
        top: 300px;
        right: 24px;
        border-radius: 100%;
        background: #a93671;
        cursor: pointer;
      }

      .buttonSelect {
        position: absolute;
        height: 40px;
        width: 12px;
        bottom: 52px;
        left: 102px;
        background: #999;
        border-radius: 10px;
        -webkit-transform: rotate(63deg);
        cursor: pointer;
      }

      .buttonStart {
        position: absolute;
        height: 40px;
        width: 12px;
        bottom: 58px;
        left: 156px;
        background: #999;
        border-radius: 10px;
        -webkit-transform: rotate(63deg);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="gameboy">
      <div class="screen">
        <canvas width="160" height="144"></canvas>
      </div>
      <div class="pad"></div>
      <div class="right"></div>
      <div class="down"></div>
      <div class="up"></div>
      <div class="left"></div>
      <div class="hole"></div>
      <div class="buttonB"></div>
      <div class="buttonA"></div>
      <div class="buttonSelect"></div>
      <div class="buttonStart"></div>
      <div class="led"></div>
    </div>
  </body>
</html>
